<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Writing Eco â€” ë‚˜ì˜ í™˜ê²½ ê¸°ë¡ ì¼ê¸°</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><circle cx='32' cy='32' r='30' fill='%23e8f7e9' /><text x='50%' y='54%' font-size='26' text-anchor='middle' fill='%236bbf72' font-family='Arial'>â„ï¸</text></svg>">

<style>
/* =========================
   Palette & base styles
   ========================= */
:root{
  --bg: #fbfefb;
  --card: #ffffff;
  --muted: #7b8a7b;
  --accent: #6bbf72;
  --accent-2: #9fd9a8;
  --danger: #ff6f6f;
  --soft: #f0fff2;
  --glass: rgba(255,255,255,0.7);
  --shadow: 0 8px 20px rgba(30,40,30,0.06);
  --radius: 14px;
  --max-width: 1100px;
  --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", "Helvetica Neue", Arial;
}

*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);font-family:var(--font-sans);color:#243022;margin:0}
a{color:inherit}
.container{max-width:var(--max-width);margin:0 auto;padding:36px 20px}

/* header */
.header{
  background: linear-gradient(180deg, rgba(107,191,114,0.12), rgba(159,217,168,0.06));
  padding:48px 20px;
  border-radius:0 0 26px 26px;
  box-shadow:var(--shadow);
}
.header-inner{display:flex;gap:20px;align-items:center;justify-content:space-between;max-width:var(--max-width);margin:0 auto}
.brand{
  display:flex;gap:16px;align-items:center;
}
.logo-wrap{width:78px;height:78px;flex:0 0 78px;border-radius:18px;background:linear-gradient(135deg,#eafaf0,#f7fff7);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(27,52,31,0.06)}
.logo-mark{width:56px;height:56px}
.title{font-size:20px;font-weight:800;color:var(--accent)}
.subtitle{font-size:13px;color:var(--muted);margin-top:4px}

/* top actions */
.top-actions{display:flex;gap:12px;align-items:center}
.btn{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 12px rgba(107,191,114,0.12)}
.btn.secondary{background:#ffffff;color:var(--accent);border:1px solid #e6efe6}
.small-muted{font-size:12px;color:var(--muted)}

/* sections */
.section{padding:48px 20px}
.section h2{color:var(--accent);margin:0 0 8px 0;font-size:20px}
.card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin-top:16px}

/* calendar grid */
.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:12px;
  margin-top:18px;
}
.cal-day{
  min-height:90px;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fcfff8);display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;border:1px solid rgba(30,40,30,0.04);
  transition:transform .15s ease, box-shadow .15s ease;
}
.cal-day:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(28,44,23,0.08)}
.cal-day .date{font-weight:800;color:#38563a}
.cal-day .dots{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.dot{width:12px;height:12px;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.07);display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:white}

/* color coding: we'll compute translucent backgrounds inline via JS */
.score-bar{height:8px;border-radius:8px;margin-top:10px;background:linear-gradient(90deg,#f4f6f4,#eefaf0)}

/* today highlight */
.is-today{outline:3px solid rgba(107,191,114,0.2);}

/* modal */
.modal{
  position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(10,12,8,0.34),rgba(10,12,8,0.26));
  z-index:80;padding:20px;
}
.modal.open{display:flex}
.modal-card{width:100%;max-width:520px;background:var(--card);border-radius:16px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.25)}

/* form list */
.actions-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.action-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:var(--soft);border:1px solid rgba(100,130,100,0.06)}
.action-item input{accent-color:var(--accent)}
.action-label{font-size:14px;color:#35573a;font-weight:700}

/* emotion */
.emotion-row{display:flex;gap:10px;margin-top:12px;align-items:center}
.emotion{padding:8px;border-radius:10px;background:#fff;border:1px solid #f0f0f0;cursor:pointer;display:flex;align-items:center;gap:8px}
.emotion.selected{box-shadow:inset 0 -6px 0 rgba(107,191,114,0.08)}

/* footer / stats */
.stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
.stat{flex:1;min-width:160px;background:linear-gradient(180deg,#fbfff9,#f1fbf0);padding:12px;border-radius:12px;text-align:center}

/* background scene (top) */
.scene{
  position:fixed;right:20px;top:120px;width:360px;height:240px;border-radius:18px;padding:12px;background:linear-gradient(180deg,#eaf9ed,#f6fff9);box-shadow:var(--shadow);z-index:5;display:flex;flex-direction:column;align-items:center;justify-content:center}
.scene .weather{font-weight:800;color:var(--accent);margin-bottom:6px}
.scene .desc{color:var(--muted);font-size:13px}

/* responsive */
@media(max-width:900px){
  .header-inner{flex-direction:column;gap:14px;align-items:flex-start}
  .scene{display:none}
}
</style>
</head>
<body>

<!-- =============== Header =============== -->
<header class="header" id="top">
  <div class="header-inner container">
    <div class="brand">
      <div class="logo-wrap" aria-hidden="true">
        <!-- simple polar-bear holding globe SVG (symbolic) -->
        <svg class="logo-mark" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="polar bear holding globe">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#dff6e9"/>
              <stop offset="1" stop-color="#e8fbef"/>
            </linearGradient>
          </defs>
          <rect rx="20" width="120" height="120" fill="url(#g1)"/>
          <!-- simple cute icon -->
          <g transform="translate(12,12)" fill="#3b6246">
            <circle cx="46" cy="36" r="18" fill="#ffffff" />
            <circle cx="54" cy="28" r="8" fill="#e1f7e7"/>
            <path d="M36 58c12 12 30 12 42 0" stroke="#c9e8cf" stroke-width="3" fill="none" stroke-linecap="round"/>
            <circle cx="46" cy="36" r="3" fill="#3b6246"/>
            <circle cx="52" cy="34" r="2.2" fill="#3b6246"/>
          </g>
        </svg>
      </div>
      <div>
        <div class="title">Writing Eco</div>
        <div class="subtitle">â€œë‚˜ì˜ í™˜ê²½ ê¸°ë¡ ì¼ê¸°â€ â€” ë‚´ ì‘ì€ ê¸°ë¡ì´ ì§€êµ¬ë¥¼ ì§€í‚´</div>
      </div>
    </div>

    <div class="top-actions">
      <div class="small-muted">ì˜¤ëŠ˜ì˜ ìƒíƒœë¥¼ ê¸°ë¡í•˜ê³  ì§€êµ¬ ìƒ‰ì„ ë°”ê¿”ë³´ì„¸ìš”</div>
      <button class="btn" id="quick-record-btn">ì˜¤ëŠ˜ ê¸°ë¡í•˜ê¸°</button>
    </div>
  </div>
</header>

<!-- =============== Scene (weather/aq) =============== -->
<div class="scene" id="scene">
  <div class="weather" id="scene-main">ë¡œë”© ì¤‘â€¦</div>
  <div class="desc" id="scene-sub">í˜„ì¬ ê¸°í›„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</div>
  <div style="height:8px"></div>
  <div style="font-size:12px;color:#7b8a7b">ìœ„ì¹˜ ê¶Œí•œ í—ˆìš© ì‹œ ë” ì •í™•í•œ ì •ë³´ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤</div>
</div>

<main class="container">
  <!-- =============== Calendar Section =============== -->
  <section class="section" id="cal-section">
    <h2>ğŸ“… ì˜¤ëŠ˜ì˜ í™˜ê²½ ê¸°ë¡ ë‹¬ë ¥</h2>
    <p class="small-muted">í…€ë¸”ëŸ¬ ì‚¬ìš©, ì¼íšŒìš©í’ˆ ë¯¸ì‚¬ìš©, ë¶„ë¦¬ìˆ˜ê±° ë“± ë‹¤ì–‘í•œ í–‰ë™ì„ ì„ íƒí•´ í•œ ë‹¬ ë‹¨ìœ„ë¡œ ê¸°ë¡í•˜ì„¸ìš”. ì¢‹ì€ í–‰ë™ì€ ì´ˆë¡, ë‚˜ìœ í–‰ë™ì€ ë¹¨ê°•ìœ¼ë¡œ ì‹œê°í™”ë©ë‹ˆë‹¤.</p>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <strong id="month-title" style="font-size:16px"></strong>
          <div class="small-muted" id="sub-month"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn secondary" id="prev-month">â—€ ì´ì „</button>
          <button class="btn secondary" id="next-month">ë‹¤ìŒ â–¶</button>
        </div>
      </div>

      <div class="calendar-grid" id="calendar-grid" aria-live="polite" style="margin-top:18px"></div>

      <div class="stats">
        <div class="stat">
          <div style="font-size:18px;font-weight:800" id="month-score">0%</div>
          <div class="small-muted">ì´ë²ˆ ë‹¬ í™˜ê²½ ì ìˆ˜</div>
        </div>
        <div class="stat">
          <div style="font-size:18px;font-weight:800" id="streak">0ì¼</div>
          <div class="small-muted">ì—°ì† ì‹¤ì²œ ì¼ìˆ˜</div>
        </div>
        <div class="stat">
          <div style="font-size:18px;font-weight:800" id="green-days">0</div>
          <div class="small-muted">ì´ˆë¡ì¼ ìˆ˜</div>
        </div>
      </div>
    </div>
  </section>

  <!-- =============== Info / How it works =============== -->
  <section class="section">
    <h2>âœ¨ ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ìš”?</h2>
    <div class="card">
      <ol style="padding-left:18px">
        <li>ë‹¬ë ¥ì—ì„œ ì˜¤ëŠ˜(ë˜ëŠ” ë‚ ì§œ)ì„ í´ë¦­ â†’ 'ì˜¤ëŠ˜ì˜ í–‰ë™'ì„ ì„ íƒí•˜ì„¸ìš”.</li>
        <li>ì¢‹ì€ í–‰ë™ì€ ì´ˆë¡ìœ¼ë¡œ, ë‚˜ìœ í–‰ë™ì€ ë¹¨ê°•ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤. ì–¸ì œë“  ìˆ˜ì • ê°€ëŠ¥.</li>
        <li>ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•˜ë©´ í˜„ì¬ ë‚ ì”¨/ë¯¸ì„¸ë¨¼ì§€ ìƒíƒœê°€ ìë™ ë°˜ì˜ë˜ì–´ ë°°ê²½ì´ ë°”ë€ë‹ˆë‹¤(ì„ íƒ ì‚¬í•­).</li>
        <li>ëª¨ë“  ê¸°ë¡ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì–´ ì¬ë°©ë¬¸ ì‹œ ìœ ì§€ë©ë‹ˆë‹¤.</li>
      </ol>
      <p class="small-muted" style="margin-top:12px">ë¦¬í¬íŠ¸ë‚˜ ë°œí‘œìš©ìœ¼ë¡œ ì‚¬ìš© ì‹œ 'ë‚´ë³´ë‚´ê¸°' ê¸°ëŠ¥ì„ ì¶”ê°€í•´ ë°ì´í„°ë¥¼ CSVë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (í™•ì¥ ê°€ëŠ¥).</p>
    </div>
  </section>

  <!-- =============== Footer / Credits =============== -->
  <section class="section" style="padding-bottom:120px">
    <div style="display:flex;gap:12px;flex-direction:column">
      <div class="card">
        <strong>ë””ìì¸ ë…¸íŠ¸</strong>
        <p class="small-muted" style="margin-top:8px">íŒŒìŠ¤í…”í†¤, ë¶€ë“œëŸ¬ìš´ ê³¡ì„ , ì• ë‹ˆë©”ì´ì…˜ì„ í†µí•´ ì‚¬ìš©ìê°€ 'ê¸°ë¶„ ì¢‹ê²Œ' ì§€ì†í•  ìˆ˜ ìˆë„ë¡ ìœ ë„í•©ë‹ˆë‹¤. ë¯¸ìˆ  ì „ê³µì˜ ì‹œê°ì  ì„¤ê³„(ì¼ëŸ¬ìŠ¤íŠ¸, ìœ¤ê³½, ìƒ‰ì±„)ê°€ í•µì‹¬ì…ë‹ˆë‹¤.</p>
      </div>

      <div class="card">
        <strong>ë¡œê³  ì„¤ëª…</strong>
        <p class="small-muted" style="margin-top:8px">ê·€ì—¬ìš´ ë¶ê·¹ê³°(ìƒì§•)ì´ ì§€êµ¬ë¥¼ ì•ˆê³  ìˆëŠ” ì‹¬ë³¼ì„ ë©”ì¸ ì•„ì´ë´í‹°í‹°ë¡œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì¹œê·¼í•œ ë©”ì‹œì§€ë¡œ ì§€ì† ì‹¤ì²œì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
      </div>
    </div>
  </section>
</main>

<!-- =============== Modal (record) =============== -->
<div class="modal" id="record-modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-card" role="document">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <h3 id="modal-date">ë‚ ì§œ</h3>
        <div class="small-muted" id="modal-sub">ê¸°ë¡ ë‚´ìš©ì„ ì„ íƒí•˜ì„¸ìš”</div>
      </div>
      <div>
        <button class="btn secondary" id="delete-day">ì‚­ì œ</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <div style="font-weight:700;margin-bottom:6px">ì˜¤ëŠ˜ì˜ í–‰ë™ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</div>
      <div class="actions-grid" id="actions-grid">
        <!-- action items injected by JS -->
      </div>
    </div>

    <div style="margin-top:12px">
      <div style="font-weight:700;margin-bottom:6px">ì˜¤ëŠ˜ ëŠë‚Œ ì„ íƒ</div>
      <div class="emotion-row" id="emotion-row">
        <!-- emotion buttons -->
      </div>
    </div>

    <div style="margin-top:12px">
      <div style="font-weight:700;margin-bottom:6px">ë©”ëª¨ (ì„ íƒ)</div>
      <textarea id="memo" rows="3" style="width:100%;padding:10px;border-radius:10px;border:1px solid #e6efe6"></textarea>
    </div>

    <div style="display:flex;gap:8px;margin-top:14px;justify-content:flex-end">
      <button id="close-modal" class="btn secondary">ì·¨ì†Œ</button>
      <button id="save-entry" class="btn">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Data & Action Definitions
   ========================= */

/*
  actions: ê° í–‰ë™ì€ 'score'ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
  score: +1 ~ +3 (í™˜ê²½ì— ì¢‹ì€ í–‰ë™), -1 ~ -3 (ë‚˜ìœ í–‰ë™)
  decompositionYears: í”Œë¼ìŠ¤í‹± ë“± ë‚˜ìœ ì•„ì´í…œì— ëŒ€í•œ ë¶„í•´ ê¸°ê°„ (í‘œì‹œìš©)
*/
const ACTIONS = [
  { id: 'tumbler', label: 'í…€ë¸”ëŸ¬ ì‚¬ìš©', score: 2, icon:'â™»ï¸' },
  { id: 'public-transport', label: 'ëŒ€ì¤‘êµí†µ ì´ìš©', score: 2, icon:'ğŸšŒ' },
  { id: 'recycle', label: 'ë¶„ë¦¬ìˆ˜ê±° ì² ì €', score: 1, icon:'ğŸ”„' },
  { id: 'upcycle', label: 'ì—…ì‚¬ì´í´ë§/ì¬í™œìš© ì œì‘', score: 2, icon:'âœ‚ï¸' },
  { id: 'meatless', label: 'ì±„ì‹ ìœ„ì£¼ ì‹ì‚¬', score: 1, icon:'ğŸ¥—' },
  { id: 'no-single', label: 'ì¼íšŒìš©í’ˆ ë¯¸ì‚¬ìš©', score: 3, icon:'ğŸŒ¿' },

  { id: 'straw', label: 'í”Œë¼ìŠ¤í‹± ë¹¨ëŒ€ ì‚¬ìš©', score: -2, icon:'ğŸ§‹', decomposition: 200 },
  { id: 'single-cup', label: 'ì¼íšŒìš© ì»µ ì‚¬ìš©', score: -2, icon:'â˜•', decomposition: 450 },
  { id: 'plastic-bag', label: 'ë¹„ë‹ë´‰ì§€ ì‚¬ìš©', score: -1, icon:'ğŸ›ï¸', decomposition: 100 },
  { id: 'litter', label: 'ê¸¸ê±°ë¦¬ ì“°ë ˆê¸° íˆ¬ê¸°', score: -3, icon:'ğŸš¯', decomposition: 500 }
];

const EMOTIONS = [
  { id:'happy', label:'ê¸°ì¨', emoji:'ğŸ˜Š' },
  { id:'ok', label:'ê´œì°®ìŒ', emoji:'ğŸ™‚' },
  { id:'tired', label:'í”¼ê³¤', emoji:'ğŸ˜´' },
  { id:'sad', label:'ìš°ìš¸', emoji:'ğŸ˜”' },
  { id:'proud', label:'ë¿Œë“¯', emoji:'ğŸ˜Œ' }
];

/* =========================
   Utilities: date helpers
   ========================= */
function pad(n){return n<10? '0'+n : ''+n}
function dateKey(y,m,d){ return `${y}-${pad(m)}-${pad(d)}` }
function monthTitle(year, month){
  const dt = new Date(year, month-1, 1);
  return dt.toLocaleString('ko-KR',{month:'long', year:'numeric'});
}

/* =========================
   Storage & State
   ========================= */
const STORAGE_KEY = 'writing-eco-entries-v1';
let entries = {}; // { '2025-11-07': {actions:[], emotion:'', memo:'' } }
function loadEntries(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) entries = JSON.parse(raw);
  }catch(e){ entries = {}; console.error('loadEntries',e) }
}
function saveEntries(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }catch(e){ console.error('saveEntries',e) }
}

/* =========================
   Calendar state
   ========================= */
let viewYear, viewMonth; // year, month(1-12)
const today = new Date();
viewYear = today.getFullYear();
viewMonth = today.getMonth() + 1;

/* =========================
   DOM Refs
   ========================= */
const calendarGrid = document.getElementById('calendar-grid');
const monthTitleEl = document.getElementById('month-title');
const subMonthEl = document.getElementById('sub-month');
const monthScoreEl = document.getElementById('month-score');
const streakEl = document.getElementById('streak');
const greenDaysEl = document.getElementById('green-days');

const recordModal = document.getElementById('record-modal');
const modalDate = document.getElementById('modal-date');
const modalSub = document.getElementById('modal-sub');
const actionsGrid = document.getElementById('actions-grid');
const emotionRow = document.getElementById('emotion-row');
const memoEl = document.getElementById('memo');
const saveEntryBtn = document.getElementById('save-entry');
const closeModalBtn = document.getElementById('close-modal');
const deleteDayBtn = document.getElementById('delete-day');
const quickRecordBtn = document.getElementById('quick-record-btn');

loadEntries();

/* =========================
   Render helpers
   ========================= */
function clearChildren(el){ while(el.firstChild) el.removeChild(el.firstChild) }

/* compute days in month */
function daysInMonth(y,m){ return new Date(y,m,0).getDate() }

/* compute entry score */
function computeScoreForDate(key){
  const e = entries[key];
  if(!e || !e.actions) return 0;
  return e.actions.reduce((s,a)=>{
    const act = ACTIONS.find(x=>x.id===a);
    return s + (act?act.score:0);
  },0);
}

function computeMonthStats(y,m){
  const days = daysInMonth(y,m);
  let totalScore = 0, goodDays=0, streak=0, maxStreak=0, curStreak=0;
  for(let d=1; d<=days; d++){
    const key = dateKey(y,m,d);
    const s = computeScoreForDate(key);
    totalScore += s;
    if(s>0) { goodDays++ ; curStreak++; maxStreak = Math.max(maxStreak, curStreak) }
    else { curStreak =0 }
  }
  const possible = days * 3; // rough scale
  const percent = Math.max(0, Math.round((totalScore + days*1.5) / (days*3) * 100)); // normalized
  return { percent, goodDays, maxStreak };
}

/* generate calendar */
function renderCalendar(y,m){
  clearChildren(calendarGrid);
  monthTitleEl.textContent = monthTitle(y,m);
  subMonthEl.textContent = `${y}ë…„ ${m}ì›”`

  const firstDay = new Date(y, m-1, 1).getDay(); // 0-6 (Sun-Sat)
  const days = daysInMonth(y,m);

  // Fill leading blanks (Sunday-first layout)
  const blanks = firstDay; // number of empty slots
  for(let i=0;i<blanks;i++){
    const el = document.createElement('div');
    el.className = 'cal-day';
    el.style.visibility = 'hidden';
    calendarGrid.appendChild(el);
  }

  for(let d=1; d<=days; d++){
    const key = dateKey(y,m,d);
    const el = document.createElement('div');
    el.className = 'cal-day';
    el.setAttribute('data-date', key);

    // date header
    const dateDiv = document.createElement('div');
    dateDiv.className = 'date';
    dateDiv.textContent = d + 'ì¼';
    el.appendChild(dateDiv);

    // small icons / dots
    const dots = document.createElement('div');
    dots.className = 'dots';
    const e = entries[key];
    if(e && e.actions && e.actions.length>0){
      e.actions.slice(0,6).forEach(aid=>{
        const act = ACTIONS.find(x=>x.id===aid);
        const dot = document.createElement('div');
        dot.className='dot';
        // color by score
        if(act.score>0) dot.style.background = 'linear-gradient(180deg,#7ee08a,#3cae57)';
        else dot.style.background = 'linear-gradient(180deg,#ff9b9b,#ff6f6f)';
        dot.title = act?act.label:'';
        dot.textContent = act?act.icon:'â€¢';
        dots.appendChild(dot);
      })
    } else {
      const hint = document.createElement('div');
      hint.className = 'small-muted';
      hint.style.fontSize='12px';
      hint.textContent = 'ì•„ì§ ê¸°ë¡ ì—†ìŒ';
      dots.appendChild(hint);
    }
    el.appendChild(dots);

    // score bar (visual subtle)
    const score = computeScoreForDate(key);
    const bar = document.createElement('div');
    bar.className = 'score-bar';
    // compute color by score (-3..+6 roughly)
    const color = scoreColor(score);
    bar.style.background = `linear-gradient(90deg, ${color} 0%, rgba(255,255,255,0) 100%)`;
    el.appendChild(bar);

    // highlight today
    if(y===today.getFullYear() && m===today.getMonth()+1 && d===today.getDate()){
      el.classList.add('is-today');
    }

    // click handler
    el.addEventListener('click', ()=> openRecordModal(key));
    calendarGrid.appendChild(el);
  }

  // update stats
  const stats = computeMonthStats(y,m);
  monthScoreEl.textContent = `${stats.percent}%`;
  greenDaysEl.textContent = stats.goodDays;
  streakEl.textContent = `${stats.maxStreak}ì¼`;

}

/* helper: map score to color */
function scoreColor(score){
  // score range approx [-3 .. +6]
  if(score<=-2) return 'rgba(255,111,111,0.95)'; // bad
  if(score<0) return 'rgba(255,160,160,0.9)';
  if(score===0) return 'rgba(230,230,230,0.35)';
  if(score<=2) return 'rgba(150,220,160,0.85)';
  return 'rgba(80,180,120,0.95)';
}

/* =========================
   Modal: build content and interaction
   ========================= */

let currentEditingKey = null;

function openRecordModal(key){
  currentEditingKey = key;
  const d = new Date(key);
  modalDate.textContent = `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
  modalSub.textContent = 'ì˜¤ëŠ˜ í•œ í–‰ë™ì„ ì„ íƒí•˜ê³  ì €ì¥í•˜ì„¸ìš”';

  // populate actions
  clearChildren(actionsGrid);
  ACTIONS.forEach(act=>{
    const id = 'act-'+act.id;
    const wrap = document.createElement('label');
    wrap.className = 'action-item';
    wrap.innerHTML = `<input type="checkbox" id="${id}" data-aid="${act.id}"> <div class="action-label">${act.icon} ${act.label}</div>`;
    actionsGrid.appendChild(wrap);
  });

  // populate emotion buttons
  clearChildren(emotionRow);
  EMOTIONS.forEach(em=>{
    const b = document.createElement('div');
    b.className = 'emotion';
    b.setAttribute('data-em', em.id);
    b.innerHTML = `<div style="font-size:18px">${em.emoji}</div><div style="font-size:13px">${em.label}</div>`;
    b.addEventListener('click', ()=> {
      Array.from(emotionRow.children).forEach(x=>x.classList.remove('selected'));
      b.classList.add('selected');
    });
    emotionRow.appendChild(b);
  });

  // load existing
  const entry = entries[key];
  if(entry){
    // check actions
    entry.actions.forEach(aid=>{
      const c = document.querySelector(`#act-${aid}`);
      if(c) c.checked = true;
    });
    // emotion
    if(entry.emotion){
      const btn = emotionRow.querySelector(`[data-em="${entry.emotion}"]`);
      if(btn) btn.classList.add('selected');
    }
    memoEl.value = entry.memo || '';
  } else {
    memoEl.value = '';
  }

  // show decomposition hint if any bad actions present
  toggleDeleteButton(!!entry);

  recordModal.classList.add('open');
  recordModal.setAttribute('aria-hidden','false');
}

/* Save logic */
saveEntryBtn.addEventListener('click', ()=>{
  if(!currentEditingKey) return;
  const checked = Array.from(actionsGrid.querySelectorAll('input[type=checkbox]:checked')).map(x=>x.dataset.aid);
  const emotionBtn = emotionRow.querySelector('.emotion.selected');
  const emotion = emotionBtn ? emotionBtn.dataset.em : '';
  const memo = memoEl.value.trim();

  if(checked.length===0 && memo===''){
    // if empty, treat as delete
    delete entries[currentEditingKey];
  } else {
    entries[currentEditingKey] = { actions: checked, emotion, memo, updatedAt: Date.now() };
  }
  saveEntries();
  renderCalendar(viewYear, viewMonth);
  recordModal.classList.remove('open');
  recordModal.setAttribute('aria-hidden','true');
  // after save, if any bad action, show decomposition modal small tooltip
  const bad = checked.filter(id => {
    const a = ACTIONS.find(x=>x.id===id);
    return a && a.score < 0;
  });
  if(bad.length>0){
    setTimeout(()=> showPlasticTimerPopup(bad), 350);
  }
});

/* delete day */
deleteDayBtn.addEventListener('click', ()=>{
  if(!currentEditingKey) return;
  if(entries[currentEditingKey]) delete entries[currentEditingKey];
  saveEntries();
  renderCalendar(viewYear, viewMonth);
  recordModal.classList.remove('open');
  recordModal.setAttribute('aria-hidden','true');
});

/* close */
closeModalBtn.addEventListener('click', ()=>{
  recordModal.classList.remove('open');
  recordModal.setAttribute('aria-hidden','true');
});

/* quick record button opens modal for today */
quickRecordBtn.addEventListener('click', ()=>{
  const key = dateKey(today.getFullYear(), today.getMonth()+1, today.getDate());
  openRecordModal(key);
});

/* outside click close */
recordModal.addEventListener('click', (e)=>{
  if(e.target === recordModal){
    recordModal.classList.remove('open');
    recordModal.setAttribute('aria-hidden','true');
  }
});

/* =========================
   Plastic timer popup (small)
   ========================= */
function showPlasticTimerPopup(badIds){
  // compute decomposition years
  const years = badIds.map(id => {
    const a = ACTIONS.find(x=>x.id===id);
    return a.decomposition || null;
  }).filter(Boolean);

  if(years.length===0) return;
  const min = Math.min(...years);
  const max = Math.max(...years);

  alert(`ì£¼ì˜: ì˜¤ëŠ˜ ê¸°ë¡í•œ ì¼íšŒìš©í’ˆì€ ë¶„í•´ë˜ê¸°ê¹Œì§€ ì•½ ${min}~${max}ë…„ì´ ê±¸ë¦½ë‹ˆë‹¤. ì‘ì€ ì„ íƒì´ ì¤‘ìš”í•´ìš”.`);
}

/* =========================
   Month navigation
   ========================= */
document.getElementById('prev-month').addEventListener('click', ()=>{
  const dt = new Date(viewYear, viewMonth-2, 1);
  viewYear = dt.getFullYear(); viewMonth = dt.getMonth()+1;
  renderCalendar(viewYear, viewMonth);
});
document.getElementById('next-month').addEventListener('click', ()=>{
  const dt = new Date(viewYear, viewMonth, 1);
  viewYear = dt.getFullYear(); viewMonth = dt.getMonth()+1;
  renderCalendar(viewYear, viewMonth);
});

/* =========================
   Weather / AQ Integration (attempt)
   ========================= */
const sceneMain = document.getElementById('scene-main');
const sceneSub = document.getElementById('scene-sub');

async function fetchAndApplyEnvironmentalData(){
  // Try to get geolocation
  if(!navigator.geolocation){
    applySimulatedScene();
    return;
  }
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    // Try Open-Meteo for weather
    try{
      const wres = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
      const wjson = await wres.json();
      const cw = wjson.current_weather;
      // Try OpenAQ for AQ data (may be blocked)
      let aqiText = '';
      try{
        const aqres = await fetch(`https://api.openaq.org/v2/latest?coordinates=${lat},${lon}`);
        const aqj = await aqres.json();
        if(aqj && aqj.results && aqj.results.length>0){
          // approximate display
          const m = aqj.results[0].measurements && aqj.results[0].measurements[0];
          if(m){
            aqiText = `${m.parameter} ${m.value}${m.unit}`;
          }
        }
      }catch(e){ /* ignore */ }

      // Apply scene changes
      sceneMain.textContent = `${cw.temperature}â„ƒ, ë°”ëŒ ${Math.round(cw.windspeed)} m/s`;
      sceneSub.textContent = `í˜„ì¬ í•˜ëŠ˜: ${cw.weathercode} ${aqiText ? ' | ê³µê¸°: ' + aqiText : ''}`;
      applySceneStyle(cw.temperature, aqiText);
    }catch(e){
      console.warn('env fetch failed', e);
      applySimulatedScene();
    }
  }, (err)=>{
    console.warn('geolocation denied or failed', err);
    applySimulatedScene();
  }, {timeout:7000});
}

function applySimulatedScene(){
  // graceful fallback: pick a friendly simulated state
  sceneMain.textContent = 'ë§‘ìŒ, 18â„ƒ';
  sceneSub.textContent = 'ì˜¤ëŠ˜ì€ ë§‘ì€ ë‚ ì´ì—ìš” â€” ì‹¤ì²œí•˜ê¸° ì¢‹ì€ ë‚ ì…ë‹ˆë‹¤.';
  applySceneStyle(18, '');
}

function applySceneStyle(temp, aqi){
  // set subtle variations, could be expanded
  const scene = document.getElementById('scene');
  if(temp >= 30) scene.style.background = 'linear-gradient(180deg,#fff2e6,#fff9f2)';
  else if(temp >= 20) scene.style.background = 'linear-gradient(180deg,#eaf9ed,#f6fff9)';
  else scene.style.background = 'linear-gradient(180deg,#eef5ff,#f8fbff)';

  // if aqi indicates bad, show warning
  if(aqi && aqi.toLowerCase().includes('pm25')){
    sceneMain.style.color = '#c94a4a';
    sceneSub.style.color = '#a63b3b';
  } else {
    sceneMain.style.color = 'var(--accent)';
    sceneSub.style.color = 'var(--muted)';
  }
}

/* =========================
   Init
   ========================= */
renderCalendar(viewYear, viewMonth);
fetchAndApplyEnvironmentalData();

/* =========================
   Accessibility: keyboard quick open
   ========================= */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'n'){ // open today's record with 'n'
    quickRecordBtn.click();
  }
});

/* =========================
   Final notes & checks (self-validation)
   - All DOM insertions are guarded and created dynamically.
   - localStorage is used with STORAGE_KEY.
   - No external key required for basic operation.
   - Weather/AQ fetching uses public endpoints (Open-Meteo / OpenAQ). If blocked, falls back.
   ========================= */

</script>

</body>
</html>
